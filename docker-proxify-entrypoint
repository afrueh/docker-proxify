#!/bin/sh

# setup redsocks and iptables rules
docker-proxify-daemon --http_proxy=${http_proxy} --https_proxy=${https_proxy} \
                      --socks4_proxy=${socks4_proxy} --socks5_proxy=${socks5_proxy}

# add a local route if requested (to avoid docker choosing it for the bridge)
# N.B. should also make sure this is skipped in redsocks
if [ -n "${local_net}" ]
then
    echo "Adding explicit route for ${local_net}"
    ip route add $(ip route get to ${local_net} | head -n 1)
fi

# setup and launch docker daemon
docker-in-docker-setup

# wait for docker to create domain socket
if [ \! -S /var/run/docker.sock ]
then
    echo -n "Waiting for docker daemon to start."
    while [ \! -S /var/run/docker.sock ]
    do
	echo -n "."
	sleep 0.002 || sleep 1
    done
    echo " ready."
fi

# launch requested command
sh -c "$*"
